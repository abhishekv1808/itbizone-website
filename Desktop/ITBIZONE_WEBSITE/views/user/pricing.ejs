<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../partials/head') %>
    <style>
        /* Custom scrollbar styling */
        #selected-services::-webkit-scrollbar {
            width: 6px;
        }
        
        #selected-services::-webkit-scrollbar-track {
            background: transparent;
        }
        
        #selected-services::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, #3b82f6, #06b6d4);
            border-radius: 3px;
        }
        
        #selected-services::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(to bottom, #2563eb, #0891b2);
        }
        
        /* Firefox scrollbar */
        #selected-services {
            scrollbar-width: thin;
            scrollbar-color: #3b82f6 transparent;
        }

        /* Mobile responsive pricing panel */
        #pricing-panel {
            bottom: 0;
            right: 0;
            left: 0;
            width: 100%;
            max-width: 100%;
            border-radius: 2rem 2rem 0 0;
            max-height: 45vh;
        }

        @media (min-width: 768px) {
            #pricing-panel {
                bottom: 2rem;
                right: 2rem;
                left: auto;
                width: 384px;
                max-width: 384px;
                border-radius: 1rem;
                max-height: 85vh;
            }
        }

        /* Prevent body scroll when quote panel is open on mobile */
        @media (max-width: 767px) {
            body.quote-open {
                overflow: hidden;
            }
            
            main {
                padding-bottom: 5rem;
            }
        }
    </style>
</head>
<body>
    <%- include('../partials/navbar') %>

    <main class="min-h-screen bg-gradient-to-b from-slate-900 via-slate-800 to-slate-900">
        <!-- Hero Section -->
        <section class="pt-20 pb-16 bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
            <div class="max-w-5xl px-4 mx-auto text-center">
                <div class="mb-6">
                    <span class="inline-block px-4 py-2 mb-4 text-xs font-semibold text-blue-400 rounded-full sm:text-sm bg-blue-400/10">💰 Transparent Pricing</span>
                    <h1 class="mb-4 text-3xl font-bold text-white sm:text-4xl md:text-5xl lg:text-6xl">Choose Your Services</h1>
                    <p class="text-sm text-gray-400 sm:text-base md:text-lg">Select any combination of services and get an instant quote. 10% discount on service bundles.</p>
                </div>
            </div>
        </section>

        <!-- Services Grid -->
        <section class="px-4 py-12 md:py-16 bg-gradient-to-b from-slate-800 to-slate-900">
            <div class="mx-auto max-w-7xl">
                <div class="grid grid-cols-1 gap-6 md:gap-8">
                    
                    <!-- Website Development -->
                    <div class="relative p-5 transition-all duration-300 border md:p-8 group bg-gradient-to-br from-slate-800 to-slate-900 border-slate-700 rounded-2xl hover:border-blue-500/50">
                        <div class="absolute inset-0 transition-opacity duration-300 opacity-0 bg-gradient-to-r from-blue-500/5 to-transparent rounded-2xl group-hover:opacity-100"></div>
                        <div class="relative z-10">
                            <h3 class="mb-2 text-xl font-bold text-white md:text-2xl">🌐 Website Development</h3>
                            <p class="mb-5 text-xs text-gray-400 md:mb-6 md:text-sm">Build, design, and optimize high-performing websites.</p>
                            <div class="grid grid-cols-1 gap-2 md:gap-3 sm:grid-cols-2 lg:grid-cols-3">
                                <% services.websiteDevelopment.subServices.forEach(service => { %>
                                <div class="flex items-start p-2 transition-colors rounded-lg cursor-pointer md:p-3 hover:bg-slate-700/30">
                                    <input type="checkbox" data-price="<%= service.price %>" style="cursor: pointer; width: 18px; height: 18px; margin-right: 12px; margin-top: 2px; flex-shrink: 0;" />
                                    <span style="font-size: 13px; line-height: 1.4; color: #d1d5db;"><%= service.name %> <span style="font-size: 11px; color: #9ca3af; display: block;">₹<%= service.price.toLocaleString('en-IN') %></span></span>
                                </div>
                                <% }); %>
                            </div>
                        </div>
                    </div>

                    <!-- Graphic Design -->
                    <div class="relative p-5 transition-all duration-300 border md:p-8 group bg-gradient-to-br from-slate-800 to-slate-900 border-slate-700 rounded-2xl hover:border-pink-500/50">
                        <div class="absolute inset-0 transition-opacity duration-300 opacity-0 bg-gradient-to-r from-pink-500/5 to-transparent rounded-2xl group-hover:opacity-100"></div>
                        <div class="relative z-10">
                            <h3 class="mb-2 text-xl font-bold text-white md:text-2xl">🎨 Graphic Design</h3>
                            <p class="mb-5 text-xs text-gray-400 md:mb-6 md:text-sm">Create impactful visuals that define your brand.</p>
                            <div class="grid grid-cols-1 gap-2 md:gap-3 sm:grid-cols-2 lg:grid-cols-3">
                                <% services.graphicDesign.subServices.forEach(service => { %>
                                <div class="flex items-start p-2 transition-colors rounded-lg cursor-pointer md:p-3 hover:bg-slate-700/30">
                                    <input type="checkbox" data-price="<%= service.price %>" style="cursor: pointer; width: 18px; height: 18px; margin-right: 12px; margin-top: 2px; flex-shrink: 0;" />
                                    <span style="font-size: 13px; line-height: 1.4; color: #d1d5db;"><%= service.name %> <span style="font-size: 11px; color: #9ca3af; display: block;">₹<%= service.price.toLocaleString('en-IN') %></span></span>
                                </div>
                                <% }); %>
                            </div>
                        </div>
                    </div>

                    <!-- Digital Marketing -->
                    <div class="relative p-5 transition-all duration-300 border md:p-8 group bg-gradient-to-br from-slate-800 to-slate-900 border-slate-700 rounded-2xl hover:border-cyan-500/50">
                        <div class="absolute inset-0 transition-opacity duration-300 opacity-0 bg-gradient-to-r from-cyan-500/5 to-transparent rounded-2xl group-hover:opacity-100"></div>
                        <div class="relative z-10">
                            <h3 class="mb-2 text-xl font-bold text-white md:text-2xl">🚀 Digital Marketing</h3>
                            <p class="mb-5 text-xs text-gray-400 md:mb-6 md:text-sm">Grow your business with data-driven marketing strategies.</p>
                            <div class="grid grid-cols-1 gap-2 md:gap-3 sm:grid-cols-2 lg:grid-cols-3">
                                <% services.digitalMarketing.subServices.forEach(service => { %>
                                <div class="flex items-start p-2 transition-colors rounded-lg cursor-pointer md:p-3 hover:bg-slate-700/30">
                                    <input type="checkbox" data-price="<%= service.price %>" style="cursor: pointer; width: 18px; height: 18px; margin-right: 12px; margin-top: 2px; flex-shrink: 0;" />
                                    <span style="font-size: 13px; line-height: 1.4; color: #d1d5db;"><%= service.name %> <span style="font-size: 11px; color: #9ca3af; display: block;">₹<%= service.price.toLocaleString('en-IN') %></span></span>
                                </div>
                                <% }); %>
                            </div>
                        </div>
                    </div>

                    <!-- Social Media Management -->
                    <div class="relative p-5 transition-all duration-300 border md:p-8 group bg-gradient-to-br from-slate-800 to-slate-900 border-slate-700 rounded-2xl hover:border-orange-500/50">
                        <div class="absolute inset-0 transition-opacity duration-300 opacity-0 bg-gradient-to-r from-orange-500/5 to-transparent rounded-2xl group-hover:opacity-100"></div>
                        <div class="relative z-10">
                            <h3 class="mb-2 text-xl font-bold text-white md:text-2xl">📱 Social Media Management</h3>
                            <p class="mb-5 text-xs text-gray-400 md:mb-6 md:text-sm">Build, engage, and grow your online community.</p>
                            <div class="grid grid-cols-1 gap-2 md:gap-3 sm:grid-cols-2 lg:grid-cols-3">
                                <% services.socialMediaManagement.subServices.forEach(service => { %>
                                <div class="flex items-start p-2 transition-colors rounded-lg cursor-pointer md:p-3 hover:bg-slate-700/30">
                                    <input type="checkbox" data-price="<%= service.price %>" style="cursor: pointer; width: 18px; height: 18px; margin-right: 12px; margin-top: 2px; flex-shrink: 0;" />
                                    <span style="font-size: 13px; line-height: 1.4; color: #d1d5db;"><%= service.name %> <span style="font-size: 11px; color: #9ca3af; display: block;">₹<%= service.price.toLocaleString('en-IN') %></span></span>
                                </div>
                                <% }); %>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </section>
    </main>

    <!-- Sticky Pricing Panel -->
    <div class="fixed z-50 flex flex-col p-6 overflow-hidden transition-all duration-300 border shadow-2xl bg-gradient-to-br from-slate-800 to-slate-900 border-slate-700" id="pricing-panel">
        <!-- Mobile handle bar -->
        <div class="absolute hidden w-12 h-1 transform -translate-x-1/2 rounded-full md:hidden top-2 left-1/2 bg-slate-600"></div>
        
        <h3 class="mb-4 text-lg font-bold text-white">📊 Your Quote</h3>
        
        <!-- Selected Services List -->
        <div class="flex-1 pr-2 mb-4 overflow-y-auto min-h-[50px]">
            <div id="selected-services" class="space-y-2">
                <p class="text-sm text-gray-400">Select services to see quote</p>
            </div>
        </div>

        <!-- Pricing Summary -->
        <div class="pt-4 mt-4 space-y-3 border-t border-slate-700">
            <div class="flex justify-between text-sm">
                <span class="text-gray-300">Subtotal:</span>
                <span id="subtotal" class="font-semibold text-white">₹0</span>
            </div>
            <div class="flex justify-between text-sm">
                <span class="text-gray-300">Discount (10%):</span>
                <span id="discount" class="font-semibold text-green-400">₹0</span>
            </div>
            <div class="flex justify-between pt-3 text-lg font-bold border-t border-slate-700">
                <span class="text-white">Total:</span>
                <span id="total" class="text-transparent bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text">₹0</span>
            </div>
        </div>

        <!-- CTA Button -->
        <button onclick="generateQuotation()" class="w-full px-4 py-3 mt-4 font-semibold text-center text-white transition-all duration-300 transform rounded-lg bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 hover:scale-105">Get Started</button>
    </div>

    <!-- Client Details Modal -->
    <div id="clientModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" style="display: none;">
        <div class="relative w-full max-w-md p-8 m-4 rounded-2xl bg-gradient-to-br from-slate-800 to-slate-900 border border-slate-700 shadow-2xl">
            <!-- Close button -->
            <button onclick="closeClientModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">×</button>
            
            <!-- Title -->
            <h2 class="mb-2 text-2xl font-bold text-white">Quick Quote Request</h2>
            <p class="mb-6 text-sm text-gray-400">Please provide your details to generate your quotation</p>
            
            <!-- Form -->
            <form id="clientDetailsForm" onsubmit="submitClientDetails(event)" class="space-y-4">
                <!-- Full Name -->
                <div>
                    <label for="fullName" class="block mb-2 text-sm font-medium text-gray-300">Full Name *</label>
                    <input type="text" id="fullName" required class="w-full px-4 py-3 text-sm bg-slate-700/50 border border-slate-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="Your full name" />
                </div>
                
                <!-- Email -->
                <div>
                    <label for="email" class="block mb-2 text-sm font-medium text-gray-300">Email *</label>
                    <input type="email" id="email" required class="w-full px-4 py-3 text-sm bg-slate-700/50 border border-slate-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="your@email.com" />
                </div>
                
                <!-- Company (Optional) -->
                <div>
                    <label for="company" class="block mb-2 text-sm font-medium text-gray-300">Company (Optional)</label>
                    <input type="text" id="company" class="w-full px-4 py-3 text-sm bg-slate-700/50 border border-slate-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="Your company name" />
                </div>
                
                <!-- Phone (Optional) -->
                <div>
                    <label for="phone" class="block mb-2 text-sm font-medium text-gray-300">Phone (Optional)</label>
                    <input type="tel" id="phone" class="w-full px-4 py-3 text-sm bg-slate-700/50 border border-slate-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="+91 98765 43210" />
                </div>
                
                <!-- Buttons -->
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeClientModal()" class="flex-1 px-4 py-3 text-sm font-semibold text-gray-300 transition-colors rounded-lg bg-slate-700/50 hover:bg-slate-700">Cancel</button>
                    <button type="submit" class="flex-1 px-4 py-3 text-sm font-semibold text-white transition-all rounded-lg bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600">Generate Quote</button>
                </div>
            </form>
        </div>
    </div>

    <%- include('../partials/footer') %>

    <script src="https://cdn.jsdelivr.net/npm/@studio-freight/lenis@1.0.43/dist/lenis.min.js"></script>
    <script>
        // Store selected services globally
        let selectedServices = [];

        // Lenis - Wrapped in try-catch to prevent crashes
        try {
            if (typeof Lenis !== 'undefined') {
                const lenis = new Lenis({duration: 1.2, easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)), direction: 'vertical', smooth: true, smoothTouch: false, touchMultiplier: 2});
                function raf(time) { lenis.raf(time); requestAnimationFrame(raf); }
                requestAnimationFrame(raf);
            }
        } catch (e) {
            console.warn('Lenis not available, smooth scrolling disabled:', e);
        }

        // PRICING CALCULATOR
        function calc() {
            const cbs = document.querySelectorAll('input[type="checkbox"][data-price]');
            console.log('calc() - Found checkboxes:', cbs.length);
            
            let total = 0, items = [];
            selectedServices = [];
            
            cbs.forEach(cb => {
                if (cb.checked) {
                    const p = parseInt(cb.getAttribute('data-price'));
                    if (!isNaN(p)) {
                        total += p;
                        const serviceDiv = cb.closest('div');
                        const serviceName = serviceDiv.querySelector('span').innerText.split('₹')[0].trim();
                        items.push({name: serviceName, price: p});
                        
                        // Extract category and add to selectedServices
                        let category = 'General';
                        const parentCard = serviceDiv.closest('div[class*="relative p-"]');
                        if (parentCard) {
                            const categoryTitle = parentCard.querySelector('h3');
                            if (categoryTitle) {
                                category = categoryTitle.innerText.replace(/[🌐🎨🚀📱]/g, '').trim();
                            }
                        }
                        
                        selectedServices.push({ name: serviceName, price: p, category: category });
                    }
                }
            });
            
            console.log('Total:', total, 'Items:', items.length);
            
            const disc = Math.floor(total * 0.1);
            const fin = total - disc;
            
            const sub = document.getElementById('subtotal');
            const dis = document.getElementById('discount');
            const tot = document.getElementById('total');
            const sel = document.getElementById('selected-services');
            
            if (sub) sub.textContent = total === 0 ? '₹0' : `₹${total.toLocaleString('en-IN')}`;
            if (dis) dis.textContent = disc === 0 ? '₹0' : `₹${disc.toLocaleString('en-IN')}`;
            if (tot) tot.textContent = fin === 0 ? '₹0' : `₹${fin.toLocaleString('en-IN')}`;
            
            if (sel) {
                if (items.length === 0) {
                    sel.innerHTML = '<p class="text-sm text-gray-400">Select services to see quote</p>';
                } else {
                    sel.innerHTML = items.map(i => `
                        <div class="flex items-center justify-between pb-2 text-sm text-gray-300 border-b border-slate-700/30">
                            <span class="flex-1 text-left">${i.name}</span>
                            <span class="ml-2 font-semibold text-blue-400">₹${i.price.toLocaleString('en-IN')}</span>
                        </div>
                    `).join('');
                }
            }
            
            console.log('Updated pricing display');
        }

        // Attach listeners to checkboxes
        document.querySelectorAll('input[type="checkbox"][data-price]').forEach((cb, idx) => {
            console.log('Attaching listener to checkbox', idx);
            cb.addEventListener('change', calc);
        });

        // Initial calculation
        calc();
        console.log('Initial calc() called');

        // MODAL FUNCTIONS
        function openClientModal() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"][data-price]:checked');
            
            if (checkboxes.length === 0) {
                alert('Please select at least one service to generate a quotation');
                return;
            }

            document.getElementById('clientModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeClientModal() {
            document.getElementById('clientModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            document.getElementById('clientDetailsForm').reset();
        }

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('clientModal').style.display === 'flex') {
                closeClientModal();
            }
        });

        // Close modal on background click
        document.getElementById('clientModal').addEventListener('click', (e) => {
            if (e.target.id === 'clientModal') {
                closeClientModal();
            }
        });

        // SUBMIT FORM
        async function submitClientDetails(event) {
            event.preventDefault();

            const fullName = document.getElementById('fullName').value.trim();
            const email = document.getElementById('email').value.trim();
            const company = document.getElementById('company').value.trim();
            const phone = document.getElementById('phone').value.trim();

            // Validate email
            if (!email.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }

            // Disable submit button to prevent double submission
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = '⏳ Creating Quotation...';
            submitBtn.disabled = true;

            try {
                // Create quotation via API
                const response = await fetch('/api/quotations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        clientDetails: {
                            fullName: fullName,
                            email: email,
                            company: company || '',
                            phone: phone || ''
                        },
                        services: selectedServices
                    })
                });

                const data = await response.json();

                if (data.success) {
                    closeClientModal();
                    // Redirect to quotation page
                    window.location.href = `/quotation/${data.quotationId}`;
                } else {
                    alert('Error creating quotation: ' + (data.message || 'Unknown error'));
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error creating quotation. Please try again. Error: ' + error.message);
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        // GENERATE QUOTATION - Now opens modal instead of prompting
        function generateQuotation() {
            openClientModal();
        }
    </script>
</body>
</html>